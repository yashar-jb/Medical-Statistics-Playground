<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>P-values, Confidence Intervals & Power Playground</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --bg-elevated: #020617;
      --card-bg: #020617;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.15);
      --accent-strong: #0ea5e9;
      --text: #e5e7eb;
      --text-muted: #9ca3af;
      --danger: #f97373;
      --warning: #fbbf24;
      --success: #22c55e;
      --radius-lg: 1.25rem;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.9);
      --border-subtle: 1px solid rgba(148, 163, 184, 0.22);
      --font-sans: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
                   "Segoe UI", sans-serif;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top left, #1f2937 0, #020617 45%, #000 100%);
      color: var(--text);
      font-family: var(--font-sans);
    }

    body {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 24px;
    }

    .app-shell {
      max-width: 1200px;
      width: 100%;
      margin: auto;
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.92));
      border-radius: 1.5rem;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.35);
      padding: 24px 24px 28px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      backdrop-filter: blur(12px);
    }

    @media (max-width: 900px) {
      body { padding: 12px; }
      .app-shell {
        padding: 18px 14px 22px;
        border-radius: 1.1rem;
      }
    }

    header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 12px;
      align-items: flex-start;
    }

    .title-block h1 {
      font-size: clamp(1.6rem, 2.1vw, 1.9rem);
      margin: 0;
      letter-spacing: 0.02em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .title-pill {
      font-size: 0.8rem;
      padding: 2px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: var(--text-muted);
    }

    .subtitle {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-top: 4px;
      max-width: 760px;
    }

    .tagline {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--accent);
      background: rgba(56, 189, 248, 0.1);
      border-radius: 999px;
      padding: 4px 12px;
      border: 1px solid rgba(56, 189, 248, 0.35);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .tagline-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 10px rgba(56, 189, 248, 0.85);
    }

    h2 {
      margin: 0 0 10px;
      font-size: 1.08rem;
      letter-spacing: 0.02em;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    h2 span.label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-muted);
    }

    main {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .card {
      background: radial-gradient(circle at top right,
          rgba(56, 189, 248, 0.06) 0,
          rgba(15, 23, 42, 0.98) 40%,
          #020617 100%);
      border-radius: var(--radius-lg);
      border: var(--border-subtle);
      padding: 14px 16px 16px;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -120px;
      background-image: radial-gradient(circle at 0 -40px,
        rgba(56, 189, 248, 0.12),
        transparent 60%);
      opacity: 0.7;
      pointer-events: none;
    }

    .card-inner {
      position: relative;
      z-index: 1;
    }

    .row-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.1fr);
      gap: 16px;
    }

    @media (max-width: 1000px) {
      .row-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .hint {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .grid-2col {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
      gap: 12px;
    }

    @media (max-width: 800px) {
      .grid-2col {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .inputs-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px 12px;
      margin-bottom: 6px;
    }

    @media (max-width: 600px) {
      .inputs-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 0.82rem;
    }

    .input-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-muted);
    }

    .input-sub {
      font-size: 0.72rem;
      color: var(--text-muted);
    }

    input[type="number"], select {
      width: 100%;
      padding: 4px 6px;
      border-radius: 0.5rem;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.98);
      color: var(--text);
      font-size: 0.83rem;
    }

    input[type="number"]:focus, select:focus {
      outline: none;
      border-color: rgba(56, 189, 248, 0.9);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.4);
    }

    input[type="range"] {
      width: 100%;
    }

    button {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      border-radius: 999px;
      padding: 5px 12px;
      border: 1px solid rgba(56, 189, 248, 0.9);
      background: radial-gradient(circle at top left,
          rgba(56, 189, 248, 0.3),
          rgba(15, 23, 42, 0.98));
      color: var(--accent-strong);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    button:disabled {
      opacity: 0.4;
      cursor: default;
    }

    button:hover:not(:disabled) {
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.6);
      transform: translateY(-0.5px);
    }

    .results-card {
      border-radius: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.98);
      padding: 8px 10px 10px;
      font-size: 0.83rem;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px 10px;
    }

    @media (max-width: 600px) {
      .results-card {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .result-row {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .result-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-muted);
    }

    .result-value {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.88rem;
    }

    .result-note {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .result-highlight { color: var(--accent-strong); }
    .result-bad { color: #fecaca; }

    .big-number {
      font-size: 1.15rem;
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .big-number.good { color: var(--accent-strong); }
    .big-number.bad { color: #fecaca; }

    /* Histogram */
    .hist-wrapper {
      border-radius: 0.9rem;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: rgba(15, 23, 42, 0.96);
      padding: 8px 10px 8px;
      font-size: 0.78rem;
    }

    .hist-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 4px;
    }

    .hist-title {
      font-size: 0.82rem;
      font-weight: 500;
    }

    .hist-sub {
      font-size: 0.72rem;
      color: var(--text-muted);
    }

    .histogram {
      display: flex;
      gap: 3px;
      align-items: flex-end;
      height: 110px;
      margin-top: 4px;
    }

    .hist-bar {
      flex: 1;
      border-radius: 3px 3px 0 0;
      background: linear-gradient(to top, rgba(56, 189, 248, 0.9), rgba(56, 189, 248, 0.2));
      position: relative;
      overflow: hidden;
    }

    .hist-bar-inner {
      position: absolute;
      inset: 0;
    }

    .hist-bar-label {
      font-size: 0.64rem;
      color: var(--text-muted);
      text-align: center;
      margin-top: 4px;
    }

    .hist-xlabels {
      display: flex;
      justify-content: space-between;
      margin-top: 2px;
    }

    .hist-xlabels span {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    /* CI plot */
    .ci-wrapper {
      border-radius: 0.9rem;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: rgba(15, 23, 42, 0.96);
      padding: 8px 10px 8px;
      font-size: 0.78rem;
    }

    .ci-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 4px;
    }

    .ci-title {
      font-size: 0.82rem;
      font-weight: 500;
    }

    .ci-sub {
      font-size: 0.72rem;
      color: var(--text-muted);
    }

    .ci-legend {
      margin-top: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 0.72rem;
      color: var(--text-muted);
      align-items: center;
    }

    .legend-swatch {
      width: 10px;
      height: 10px;
      border-radius: 2px;
      border: 1px solid rgba(148, 163, 184, 0.6);
    }

    .legend-swatch.sig {
      background: rgba(56, 189, 248, 0.9);
      border-color: rgba(56, 189, 248, 0.95);
    }

    .legend-swatch.nonsig {
      background: rgba(148, 163, 184, 0.6);
      border-color: rgba(148, 163, 184, 0.9);
    }

    .legend-swatch.miss {
      background: rgba(248, 113, 113, 0.9);
      border-color: rgba(248, 113, 113, 0.95);
    }

    .pill-soft {
      font-size: 0.72rem;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.55);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-muted);
    }

    /* P-hacking sandbox */
    .ph-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.3fr);
      gap: 12px;
    }

    @media (max-width: 800px) {
      .ph-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .select-row {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 8px;
      margin-bottom: 6px;
    }

    @media (max-width: 600px) {
      .select-row {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .ph-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
      margin-bottom: 6px;
    }

    .ph-results {
      border-radius: 0.9rem;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: rgba(15, 23, 42, 0.96);
      padding: 8px 10px 8px;
      font-size: 0.78rem;
      max-height: 210px;
      overflow-y: auto;
    }

    .ph-row {
      border-bottom: 1px solid rgba(55, 65, 81, 0.8);
      padding: 4px 0;
    }

    .ph-row:last-child {
      border-bottom: none;
    }

    .ph-row strong {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    footer {
      margin-top: 8px;
      font-size: 0.72rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
<div class="app-shell">
  <header>
    <div class="title-block">
      <h1>
        P-values, CIs &amp; Power Playground
        <span class="title-pill">Trial simulator ¬∑ CIs ¬∑ P-hacking</span>
      </h1>
      <div class="subtitle">
        Simulate repeated two-group trials to see how p-values and confidence intervals behave,
        then explore a ‚Äúp-hacking‚Äù sandbox where there is <em>no true effect</em> but significant
        p-values still appear if you keep testing.
      </div>
    </div>
    <div class="tagline">
      <span class="tagline-dot"></span>
      Live statistics demo
    </div>
  </header>

  <main>
    <!-- Row 1: Two-group Trial Simulator -->
    <section class="card">
      <div class="card-inner">
        <h2>
          Two-Group Trial Simulator
          <span class="label">P-values, confidence intervals &amp; empirical power</span>
        </h2>
        <div class="hint">
          Choose the true effect size, variability, sample size and alpha. Then simulate many trials under
          exactly the same truth. You‚Äôll see a histogram of p-values, the empirical power, and how often
          95% CIs contain the true effect.
        </div>

        <div class="grid-2col">
          <div>
            <div class="inputs-grid">
              <div class="input-group">
                <div class="input-label">True effect size (Œî)</div>
                <input type="number" id="trueEffectInput" value="0.5" step="0.1" />
                <div class="input-sub">Difference in means (treatment ‚àí control).</div>
              </div>
              <div class="input-group">
                <div class="input-label">SD (both groups)</div>
                <input type="number" id="sdInput" value="1.0" step="0.1" />
                <div class="input-sub">Assumed same in both groups.</div>
              </div>
              <div class="input-group">
                <div class="input-label">Sample size per group (n)</div>
                <input type="number" id="nInput" value="50" min="5" step="5" />
                <div class="input-sub">Each simulated trial uses this n in each arm.</div>
              </div>
              <div class="input-group">
                <div class="input-label">Number of trials</div>
                <input type="number" id="trialsInput" value="100" min="10" max="500" step="10" />
                <div class="input-sub">More trials ‚âà smoother histogram (but denser CI plot).</div>
              </div>
              <div class="input-group">
                <div class="input-label">Alpha level</div>
                <select id="alphaSelect">
                  <option value="0.1">0.10</option>
                  <option value="0.05" selected>0.05</option>
                  <option value="0.01">0.01</option>
                  <option value="0.001">0.001</option>
                </select>
                <div class="input-sub">Used for significance and CI width.</div>
              </div>
              <div class="input-group">
                <div class="input-label">Null value</div>
                <input type="number" id="nullInput" value="0" step="0.1" />
                <div class="input-sub">Usually 0 (no difference), but you can change it.</div>
              </div>
            </div>
            <button id="simulateBtn">‚ñ∂ Simulate trials</button>
            <div class="hint" style="margin-top:6px;">
              Teaching trick: start with a small n (e.g. 20) and show how noisy the p-values and CIs are;
              then increase n to see power and coverage stabilize.
            </div>
            <div class="results-card" id="simStatsPanel" style="margin-top:8px;">
              <!-- filled by JS -->
            </div>
          </div>

          <div>
            <div class="hist-wrapper">
              <div class="hist-header">
                <div class="hist-title">Histogram of p-values</div>
                <div class="hist-sub">From all simulated trials under the same truth.</div>
              </div>
              <div class="histogram" id="pHist"></div>
              <div class="hist-xlabels">
                <span>0.0</span>
                <span>0.5</span>
                <span>1.0</span>
              </div>
            </div>

            <div class="ci-wrapper" style="margin-top:8px;">
              <div class="ci-header">
                <div class="ci-title">Confidence intervals across trials</div>
                <div class="ci-sub">Each line is one trial‚Äôs CI for Œî.</div>
              </div>
              <svg id="ciSvg" viewBox="0 0 320 190" style="width:100%; height:auto;">
                <!-- axes & lines filled by JS -->
              </svg>
              <div class="ci-legend">
                <span class="pill-soft">Vertical cyan line = true Œî ¬∑ Gray line = null</span>
                <span><span class="legend-swatch sig"></span> Significant (CI excludes null)</span>
                <span><span class="legend-swatch nonsig"></span> Not significant</span>
                <span><span class="legend-swatch miss"></span> CI misses the true Œî</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Row 2: P-hacking sandbox -->
    <section class="card">
      <div class="card-inner">
        <h2>
          P-hacking Sandbox (No True Effect)
          <span class="label">Multiple tests ¬∑ ‚ÄúSignificant‚Äù by chance</span>
        </h2>
        <div class="hint">
          Here we simulate a dataset where there is <strong>no real treatment effect</strong> on any outcome.
          You can slice it by subgroups and outcomes. If you try enough analyses, you‚Äôll eventually
          see p&lt;0.05 simply by chance.
        </div>

        <div class="ph-grid">
          <div>
            <div class="select-row">
              <div class="input-group">
                <div class="input-label">Outcome</div>
                <select id="phOutcome">
                  <option value="y1">Outcome 1</option>
                  <option value="y2">Outcome 2</option>
                  <option value="y3">Outcome 3</option>
                </select>
                <div class="input-sub">All three are pure noise; no true effect.</div>
              </div>
              <div class="input-group">
                <div class="input-label">Subgroup filter</div>
                <select id="phSubgroup">
                  <option value="all">All patients</option>
                  <option value="female">Sex: female only</option>
                  <option value="male">Sex: male only</option>
                  <option value="smoker">Smokers only</option>
                  <option value="nonsmoker">Non-smokers only</option>
                  <option value="young">Age &lt; 40</option>
                  <option value="old">Age ‚â• 40</option>
                </select>
                <div class="input-sub">Typical exploratory subgroup choices.</div>
              </div>
            </div>
            <div class="ph-buttons">
              <button id="phRunOneBtn">‚ñ∂ Run this analysis</button>
              <button id="phRunManyBtn">üé≤ Run 20 random analyses</button>
            </div>
            <div class="hint">
              Talking point: ‚ÄúIf you let me choose any outcome, any subgroup, and any cut-off,
              I promise I can find you a ‚Äòsignificant‚Äô p-value in a dataset with no real effect.‚Äù
            </div>
          </div>

          <div>
            <div class="ph-results" id="phResults">
              <!-- analysis log -->
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div>
      Idea: run the trial simulator with Œî=0 to show type I error, then with Œî&gt;0 to show power.
    </div>
    <div>
      Save this file as <code>pvalues_ci_power_playground.html</code> and open it offline for your EBM talk.
    </div>
  </footer>
</div>

<script>
  // ---------- Random & distribution helpers ----------

  function safeNumber(value) {
    const n = Number(value);
    return Number.isFinite(n) ? n : 0;
  }

  // Box-Muller normal(0,1)
  function randNormal() {
    let u = 0, v = 0;
    while (u === 0) u = Math.random();
    while (v === 0) v = Math.random();
    return Math.sqrt(-2 * Math.log(u)) * Math.cos(2 * Math.PI * v);
  }

  // Error function approximation (Abramowitz & Stegun 7.1.26)
  function erf(x) {
    const sign = x < 0 ? -1 : 1;
    const a1 = 0.254829592;
    const a2 = -0.284496736;
    const a3 = 1.421413741;
    const a4 = -1.453152027;
    const a5 = 1.061405429;
    const p = 0.3275911;
    const absx = Math.abs(x);
    const t = 1 / (1 + p * absx);
    const y =
      1 -
      (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-absx * absx);
    return sign * y;
  }

  function normalCDF(x) {
    return 0.5 * (1 + erf(x / Math.SQRT2));
  }

  // Get z critical for alpha (two-sided)
  function zCritical(alpha) {
    const a = alpha;
    if (Math.abs(a - 0.1) < 1e-6) return 1.64;
    if (Math.abs(a - 0.05) < 1e-6) return 1.96;
    if (Math.abs(a - 0.01) < 1e-6) return 2.58;
    if (Math.abs(a - 0.001) < 1e-6) return 3.29;
    // fallback using inverse CDF approximation (Beasley-Springer-Moro)
    const p = 1 - a / 2;
    return normInv(p);
  }

  // Inverse normal CDF approximation (for fallback)
  function normInv(p) {
    // Beasley-Springer/Moro approximation
    if (p <= 0 || p >= 1) return NaN;
    const a = [2.50662823884, -18.61500062529, 41.39119773534, -25.44106049637];
    const b = [-8.4735109309, 23.08336743743, -21.06224101826, 3.13082909833];
    const c = [0.3374754822726147, 0.9761690190917186, 0.1607979714918209,
               0.0276438810333863, 0.0038405729373609, 0.0003951896511919,
               0.0000321767881768, 0.0000002888167364, 0.0000003960315187];
    let x = p - 0.5;
    if (Math.abs(x) < 0.42) {
      const r = x * x;
      const num = a[0] + a[1] * r + a[2] * r * r + a[3] * r * r * r;
      const den = 1 + b[0] * r + b[1] * r * r + b[2] * r * r * r + b[3] * r * r * r * r;
      return x * num / den;
    }
    let r = p;
    if (x > 0) r = 1 - p;
    r = Math.log(-Math.log(r));
    let z = c[0] + r * (c[1] + r * (c[2] + r * (c[3] + r * (c[4] + r * (c[5] +
            r * (c[6] + r * (c[7] + r * c[8])))))));
    return x < 0 ? -z : z;
  }

  // ---------- Trial simulator ----------

  function simulateTrials() {
    const delta = safeNumber(document.getElementById("trueEffectInput").value);
    const sd = Math.max(0, safeNumber(document.getElementById("sdInput").value));
    let n = Math.floor(safeNumber(document.getElementById("nInput").value));
    if (n < 2) n = 2;
    let trials = Math.floor(safeNumber(document.getElementById("trialsInput").value));
    if (trials < 10) trials = 10;
    const alpha = parseFloat(document.getElementById("alphaSelect").value);
    const nullValue = safeNumber(document.getElementById("nullInput").value);

    const seDiff = sd * Math.sqrt(2 / n);
    const zCrit = zCritical(alpha);

    const pVals = [];
    const cis = [];
    let sigCount = 0;
    let coverCount = 0;
    let missLow = 0;
    let missHigh = 0;

    for (let i = 0; i < trials; i++) {
      // difference of means ~ Normal(delta, 2*sd^2/n)
      const diff = delta + randNormal() * seDiff;
      const z = (diff - nullValue) / seDiff;
      const p = 2 * (1 - normalCDF(Math.abs(z)));
      const ciLow = diff - zCrit * seDiff;
      const ciHigh = diff + zCrit * seDiff;
      const sig = p < alpha;
      const covers = ciLow <= delta && ciHigh >= delta;

      pVals.push(p);
      cis.push({ diff, ciLow, ciHigh, p, sig, covers });

      if (sig) sigCount++;
      if (covers) coverCount++;
      else {
        if (ciHigh < delta) missLow++;
        else if (ciLow > delta) missHigh++;
      }
    }

    renderSimStats({
      pVals,
      cis,
      trials,
      sigCount,
      coverCount,
      missLow,
      missHigh,
      alpha,
      delta,
      nullValue
    });
  }

  function renderSimStats(res) {
    const {
      pVals,
      cis,
      trials,
      sigCount,
      coverCount,
      missLow,
      missHigh,
      alpha,
      delta,
      nullValue
    } = res;

    const power = sigCount / trials;
    const coverage = coverCount / trials;

    const simPanel = document.getElementById("simStatsPanel");
    simPanel.innerHTML = `
      <div class="result-row">
        <div class="result-label">Empirical power</div>
        <div class="result-value result-highlight">
          ${(power * 100).toFixed(1)}% (${sigCount}/${trials} trials significant at Œ±=${alpha})
        </div>
        <div class="result-note">
          Proportion of trials with p &lt; Œ± (null: Œî = ${nullValue}).
        </div>
      </div>
      <div class="result-row">
        <div class="result-label">CI coverage of true Œî</div>
        <div class="result-value">
          ${(coverage * 100).toFixed(1)}% (${coverCount}/${trials})
        </div>
        <div class="result-note">
          ${missLow} CIs entirely below true Œî ¬∑ ${missHigh} CIs entirely above true Œî.
        </div>
      </div>
      <div class="result-row">
        <div class="result-label">Median p-value</div>
        <div class="result-value">${median(pVals).toFixed(3)}</div>
        <div class="result-note">
          Underpowered settings give very unstable p-values across repetitions.
        </div>
      </div>
      <div class="result-row">
        <div class="result-label">Median CI width</div>
        <div class="result-value">
          ${median(cis.map(c => c.ciHigh - c.ciLow)).toFixed(3)}
        </div>
        <div class="result-note">
          Width shrinks as n increases or SD decreases.
        </div>
      </div>
    `;

    renderPHistogram(pVals);
    renderCIPlot(cis, alpha, delta, nullValue);
  }

  function median(arr) {
    if (!arr.length) return NaN;
    const sorted = [...arr].sort((a, b) => a - b);
    const mid = Math.floor(sorted.length / 2);
    if (sorted.length % 2 === 0) {
      return (sorted[mid - 1] + sorted[mid]) / 2;
    }
    return sorted[mid];
  }

  function renderPHistogram(pVals) {
    const container = document.getElementById("pHist");
    container.innerHTML = "";
    const bins = 10;
    const counts = new Array(bins).fill(0);
    pVals.forEach(p => {
      let idx = Math.floor(p * bins);
      if (idx >= bins) idx = bins - 1;
      if (idx < 0) idx = 0;
      counts[idx]++;
    });
    const maxCount = counts.reduce((a, b) => Math.max(a, b), 0) || 1;

    counts.forEach((count, i) => {
      const bar = document.createElement("div");
      bar.className = "hist-bar";
      const h = (count / maxCount) * 100;
      bar.style.height = (h || 2) + "%";
      container.appendChild(bar);
    });
  }

  function renderCIPlot(cis, alpha, delta, nullValue) {
    const svg = document.getElementById("ciSvg");
    svg.innerHTML = "";

    if (!cis.length) return;

    let minX = Infinity;
    let maxX = -Infinity;
    cis.forEach(c => {
      if (c.ciLow < minX) minX = c.ciLow;
      if (c.ciHigh > maxX) maxX = c.ciHigh;
    });
    // Ensure true effect and null are in view
    minX = Math.min(minX, delta, nullValue);
    maxX = Math.max(maxX, delta, nullValue);
    if (minX === maxX) {
      minX -= 1;
      maxX += 1;
    }
    const marginLeft = 40;
    const marginRight = 10;
    const marginTop = 10;
    const marginBottom = 20;
    const width = 320;
    const height = 190;
    const innerW = width - marginLeft - marginRight;
    const innerH = height - marginTop - marginBottom;

    function xScale(x) {
      return marginLeft + (x - minX) / (maxX - minX) * innerW;
    }

    function yScale(i, n) {
      if (n <= 1) return marginTop + innerH / 2;
      return marginTop + (i + 0.5) * (innerH / n);
    }

    // Axis line
    const axis = document.createElementNS("http://www.w3.org/2000/svg", "line");
    axis.setAttribute("x1", marginLeft);
    axis.setAttribute("x2", marginLeft + innerW);
    axis.setAttribute("y1", height - marginBottom);
    axis.setAttribute("y2", height - marginBottom);
    axis.setAttribute("stroke", "#4b5563");
    axis.setAttribute("stroke-width", "1");
    svg.appendChild(axis);

    // Tick labels at min, midpoint, max
    const ticks = [
      { x: minX, label: minX.toFixed(2) },
      { x: (minX + maxX) / 2, label: ((minX + maxX) / 2).toFixed(2) },
      { x: maxX, label: maxX.toFixed(2) }
    ];
    ticks.forEach(t => {
      const x = xScale(t.x);
      const tick = document.createElementNS("http://www.w3.org/2000/svg", "line");
      tick.setAttribute("x1", x);
      tick.setAttribute("x2", x);
      tick.setAttribute("y1", height - marginBottom);
      tick.setAttribute("y2", height - marginBottom + 4);
      tick.setAttribute("stroke", "#6b7280");
      tick.setAttribute("stroke-width", "1");
      svg.appendChild(tick);

      const lbl = document.createElementNS("http://www.w3.org/2000/svg", "text");
      lbl.setAttribute("x", x);
      lbl.setAttribute("y", height - 4);
      lbl.setAttribute("fill", "#9ca3af");
      lbl.setAttribute("font-size", "8");
      lbl.setAttribute("text-anchor", "middle");
      lbl.textContent = t.label;
      svg.appendChild(lbl);
    });

    // Vertical lines: null and true effect
    const xNull = xScale(nullValue);
    const xTrue = xScale(delta);

    const nullLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
    nullLine.setAttribute("x1", xNull);
    nullLine.setAttribute("x2", xNull);
    nullLine.setAttribute("y1", marginTop);
    nullLine.setAttribute("y2", height - marginBottom);
    nullLine.setAttribute("stroke", "#6b7280");
    nullLine.setAttribute("stroke-width", "1");
    nullLine.setAttribute("stroke-dasharray", "4 3");
    svg.appendChild(nullLine);

    const trueLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
    trueLine.setAttribute("x1", xTrue);
    trueLine.setAttribute("x2", xTrue);
    trueLine.setAttribute("y1", marginTop);
    trueLine.setAttribute("y2", height - marginBottom);
    trueLine.setAttribute("stroke", "#22d3ee");
    trueLine.setAttribute("stroke-width", "1.5");
    svg.appendChild(trueLine);

    const n = cis.length;
    const maxLinesToPlot = 150;
    const step = n > maxLinesToPlot ? Math.ceil(n / maxLinesToPlot) : 1;

    cis.forEach((c, idx) => {
      if (idx % step !== 0) return;
      const y = yScale(idx, Math.floor(n / step));
      const x1 = xScale(c.ciLow);
      const x2 = xScale(c.ciHigh);
      const colorMiss = !c.covers;
      let stroke = "#9ca3af";
      let strokeWidth = 1;

      if (colorMiss) {
        stroke = "#f97373";
        strokeWidth = 1.5;
      } else if (c.sig) {
        stroke = "#38bdf8";
        strokeWidth = 1.5;
      }

      const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
      line.setAttribute("x1", x1);
      line.setAttribute("x2", x2);
      line.setAttribute("y1", y);
      line.setAttribute("y2", y);
      line.setAttribute("stroke", stroke);
      line.setAttribute("stroke-width", strokeWidth);
      line.setAttribute("stroke-linecap", "round");
      svg.appendChild(line);

      // point at estimate
      const xEst = xScale(c.diff);
      const dot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      dot.setAttribute("cx", xEst);
      dot.setAttribute("cy", y);
      dot.setAttribute("r", 2);
      dot.setAttribute("fill", stroke);
      svg.appendChild(dot);
    });
  }

  // ---------- P-hacking sandbox ----------

  const phData = [];

  function generateNoEffectData() {
    phData.length = 0;
    const N = 400;
    for (let i = 0; i < N; i++) {
      const group = i < N / 2 ? "A" : "B"; // randomized 1:1
      const sex = Math.random() < 0.5 ? "M" : "F";
      const smoker = Math.random() < 0.3 ? 1 : 0;
      const age = 20 + Math.round(Math.random() * 50); // 20‚Äì70
      // Outcomes: pure noise, identical distribution in both groups
      const y1 = randNormal();
      const y2 = randNormal();
      const y3 = randNormal();
      phData.push({ group, sex, smoker, age, y1, y2, y3 });
    }
  }

  function filterPhData(subgroup) {
    return phData.filter(p => {
      switch (subgroup) {
        case "female": return p.sex === "F";
        case "male": return p.sex === "M";
        case "smoker": return p.smoker === 1;
        case "nonsmoker": return p.smoker === 0;
        case "young": return p.age < 40;
        case "old": return p.age >= 40;
        default: return true;
      }
    });
  }

  function meanAndVar(arr) {
    const n = arr.length;
    if (!n) return { mean: NaN, variance: NaN };
    const m = arr.reduce((s, x) => s + x, 0) / n;
    const v = arr.reduce((s, x) => s + (x - m) * (x - m), 0) / (n - 1);
    return { mean: m, variance: v };
  }

  function runPhAnalysis(outcome, subgroup) {
    const subset = filterPhData(subgroup);
    const groupA = subset.filter(p => p.group === "A").map(p => p[outcome]);
    const groupB = subset.filter(p => p.group === "B").map(p => p[outcome]);

    if (groupA.length < 5 || groupB.length < 5) {
      return {
        ok: false,
        reason: `Too few patients in this subgroup (A: ${groupA.length}, B: ${groupB.length}).`
      };
    }

    const statsA = meanAndVar(groupA);
    const statsB = meanAndVar(groupB);
    const diff = statsB.mean - statsA.mean; // B ‚àí A
    const se = Math.sqrt(
      statsA.variance / groupA.length + statsB.variance / groupB.length
    );
    const z = diff / se;
    const p = 2 * (1 - normalCDF(Math.abs(z)));

    return {
      ok: true,
      outcome,
      subgroup,
      nA: groupA.length,
      nB: groupB.length,
      diff,
      p
    };
  }

  function outcomeLabel(id) {
    if (id === "y1") return "Outcome 1";
    if (id === "y2") return "Outcome 2";
    if (id === "y3") return "Outcome 3";
    return id;
  }

  function subgroupLabel(id) {
    switch (id) {
      case "female": return "Sex = female";
      case "male": return "Sex = male";
      case "smoker": return "Smokers only";
      case "nonsmoker": return "Non-smokers only";
      case "young": return "Age < 40";
      case "old": return "Age ‚â• 40";
      default: return "All patients";
    }
  }

  function appendPhResult(msgHtml) {
    const container = document.getElementById("phResults");
    const row = document.createElement("div");
    row.className = "ph-row";
    row.innerHTML = msgHtml;
    container.prepend(row);
    // limit to last ~40 rows
    while (container.children.length > 40) {
      container.removeChild(container.lastChild);
    }
  }

  function handlePhRunOne() {
    const outcome = document.getElementById("phOutcome").value;
    const subgroup = document.getElementById("phSubgroup").value;
    const res = runPhAnalysis(outcome, subgroup);
    if (!res.ok) {
      appendPhResult(`<span class="result-bad">${res.reason}</span>`);
      return;
    }
    const pTxt = res.p.toFixed(3);
    const diffTxt = res.diff.toFixed(3);
    const sig = res.p < 0.05;
    appendPhResult(`
      <div>
        <strong>${sig ? "‚òÖ" : "‚Ä¢"}</strong>
        <strong>${outcomeLabel(res.outcome)}</strong>
        in <strong>${subgroupLabel(res.subgroup)}</strong>:
        diff (B ‚àí A) = <strong>${diffTxt}</strong>,
        p = <strong class="${sig ? "result-bad" : ""}">${pTxt}</strong>
        &nbsp;[n<sub>A</sub>=${res.nA}, n<sub>B</sub>=${res.nB}]
        ${sig ? `<span class="pill-soft" style="border-color:rgba(248,113,113,0.9);color:#fecaca;">‚ÄúSignificant‚Äù at 0.05 in a null dataset</span>` : ""}
      </div>
    `);
  }

  function handlePhRunMany() {
    let sigCount = 0;
    let total = 20;
    const outcomes = ["y1", "y2", "y3"];
    const subgroups = ["all", "female", "male", "smoker", "nonsmoker", "young", "old"];
    for (let i = 0; i < total; i++) {
      const outcome = outcomes[Math.floor(Math.random() * outcomes.length)];
      const subgroup = subgroups[Math.floor(Math.random() * subgroups.length)];
      const res = runPhAnalysis(outcome, subgroup);
      if (!res.ok) continue;
      const pTxt = res.p.toFixed(3);
      const diffTxt = res.diff.toFixed(3);
      const sig = res.p < 0.05;
      if (sig) sigCount++;
      appendPhResult(`
        <div>
          <strong>${sig ? "‚òÖ" : "‚Ä¢"}</strong>
          <strong>${outcomeLabel(res.outcome)}</strong>
          in <strong>${subgroupLabel(res.subgroup)}</strong>:
          diff (B ‚àí A) = <strong>${diffTxt}</strong>,
          p = <strong class="${sig ? "result-bad" : ""}">${pTxt}</strong>
          &nbsp;[n<sub>A</sub>=${res.nA}, n<sub>B</sub>=${res.nB}]
        </div>
      `);
    }
    appendPhResult(`
      <div>
        <strong>Summary:</strong> ${sigCount} out of ${total} random analyses had p &lt; 0.05
        in a dataset with <strong>no true effect</strong>.
      </div>
    `);
  }

  // ---------- Init ----------

  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("simulateBtn").addEventListener("click", simulateTrials);
    generateNoEffectData();
    document.getElementById("phRunOneBtn").addEventListener("click", handlePhRunOne);
    document.getElementById("phRunManyBtn").addEventListener("click", handlePhRunMany);

    // initial run for a non-empty display
    simulateTrials();
  });
</script>
</body>
</html>
